From c449aa9b58aa3adb8cd188ab3176651422188db2 Mon Sep 17 00:00:00 2001
From: rchauhan <rahul.chauhan@cern.ch>
Date: Wed, 24 May 2023 11:33:39 +0200
Subject: [PATCH] Policies: Adding plugin hook for auto-approval flow

---
 lib/rucio/common/utils.py | 16 ++++++++
 lib/rucio/core/rule.py    | 83 ++++++++++++++++++++++++++++-----------
 2 files changed, 76 insertions(+), 23 deletions(-)

diff --git a/lib/rucio/common/utils.py b/lib/rucio/common/utils.py
index 3c40b8823..e1f3038f1 100644
--- a/lib/rucio/common/utils.py
+++ b/lib/rucio/common/utils.py
@@ -1754,6 +1754,22 @@ class PriorityQueue:
         return heap_changed


+def get_auto_approve_algorithms():
+    '''
+    Loads all the auto approve algorithms from the policy package(s)
+    :returns: a dictionary of auto approve algorithms
+    '''
+    global _loaded_auto_approve_algorithms
+    if not _loaded_auto_approve_algorithms:
+        register_policy_package_algorithms('auto_approve', _AUTO_APPROVE_ALGORITHMS)
+
+    return _AUTO_APPROVE_ALGORITHMS
+
+
+_AUTO_APPROVE_ALGORITHMS = {}
+_loaded_auto_approve_algorithms = False
+
+
 def register_policy_package_algorithms(algorithm_type, dictionary):
     '''
     Loads all the algorithms of a given type from the policy package(s) and registers them
diff --git a/lib/rucio/core/rule.py b/lib/rucio/core/rule.py
index d23addb08..74c41432c 100644
--- a/lib/rucio/core/rule.py
+++ b/lib/rucio/core/rule.py
@@ -17,7 +17,7 @@ import json
 import logging
 from typing import TYPE_CHECKING

-from configparser import NoOptionError
+from configparser import NoOptionError, NoSectionError

 from copy import deepcopy
 from datetime import datetime, timedelta
@@ -51,7 +51,7 @@ from rucio.common.exception import (InvalidRSEExpression, InvalidReplicationRule
                                     InvalidSourceReplicaExpression)
 from rucio.common.schema import validate_schema
 from rucio.common.types import InternalScope, InternalAccount
-from rucio.common.utils import str_to_date, sizefmt, chunks
+from rucio.common.utils import str_to_date, sizefmt, chunks, get_auto_approve_algorithms
 from rucio.core import account_counter, rse_counter, request as request_core, transfer as transfer_core
 from rucio.core.account import get_account
 from rucio.core.lifetime_exception import define_eol
@@ -254,28 +254,65 @@ def add_rule(dids, account, copies, rse_expression, grouping, weight, lifetime,

             if ask_approval:
                 new_rule.state = RuleState.WAITING_APPROVAL
-                # Block manual approval for multi-rse rules
-                if len(rses) > 1:
-                    raise InvalidReplicationRule('Ask approval is not allowed for rules with multiple RSEs')
-                if len(rses) == 1 and not did.is_open and did.bytes is not None and did.length is not None:
-                    # This rule can be considered for auto-approval:
-                    rse_attr = list_rse_attributes(rse_id=rses[0]['id'], session=session)
-                    auto_approve = False
-                    if 'auto_approve_bytes' in rse_attr and 'auto_approve_files' in rse_attr:
-                        if did.bytes < int(rse_attr.get('auto_approve_bytes')) and did.length < int(rse_attr.get('auto_approve_bytes')):
-                            auto_approve = True
-                    elif did.bytes < int(rse_attr.get('auto_approve_bytes', -1)):
-                        auto_approve = True
-                    elif did.length < int(rse_attr.get('auto_approve_files', -1)):
+                configured_algorithm, auto_approve = None, False
+                auto_approve_callable = None
+
+                try:
+                    configured_algorithm = config_get('rules', 'auto_approve_algorithm')
+                except (NoOptionError, NoSectionError, RuntimeError):
+                    configured_algorithm = None
+
+                try:
+                    AUTO_APPROVE_ALGORITHMS = get_auto_approve_algorithms()
+                    auto_approve_callable = AUTO_APPROVE_ALGORITHMS[configured_algorithm]
+                except KeyError:
+                    logger(logging.WARNING, "Auto approve algorithm %s not found in policy package", configured_algorithm)
+
+                # Evaluate the rule with the auto-approve algorithm
+                if auto_approve_callable:
+                    rule_attributes = {
+                        'account': account,
+                        'lifetime': lifetime,
+                        'rse_expression': rse_expression,
+                        'activity': activity,
+                        'copies': copies,
+                        'weight': weight,
+                        'grouping': grouping,
+                        'locked': locked,
+                        'comment': comment,
+                        'meta': meta,
+                        'ignore_availability': ignore_availability,
+                    }
+
+                    if auto_approve_callable(did, rule_attributes, session):
                         auto_approve = True
-                    if auto_approve:
-                        logger(logging.DEBUG, "Auto approving rule %s", str(new_rule.id))
-                        logger(logging.DEBUG, "Created rule %s for injection", str(new_rule.id))
-                        approve_rule(rule_id=new_rule.id, notify_approvers=False, session=session)
-                        continue
-                logger(logging.DEBUG, "Created rule %s in waiting for approval", str(new_rule.id))
-                __create_rule_approval_email(rule=new_rule, session=session)
-                continue
+
+                # Try the legacy one if not yet auto-approved
+                else:
+                    # Block manual approval for multi-rse rules
+                    if len(rses) > 1:
+                        raise InvalidReplicationRule('Ask approval is not allowed for rules with multiple RSEs')
+                    if len(rses) == 1 and not did.is_open and did.bytes is not None and did.length is not None:
+                        # This rule can be considered for auto-approval:
+                        rse_attr = list_rse_attributes(rse_id=rses[0]['id'], session=session)
+                        auto_approve = False
+                        if 'auto_approve_bytes' in rse_attr and 'auto_approve_files' in rse_attr:
+                            if did.bytes < int(rse_attr.get('auto_approve_bytes')) and did.length < int(rse_attr.get('auto_approve_files')):
+                                auto_approve = True
+                        elif did.bytes < int(rse_attr.get('auto_approve_bytes', -1)):
+                            auto_approve = True
+                        elif did.length < int(rse_attr.get('auto_approve_files', -1)):
+                            auto_approve = True
+
+                if auto_approve:
+                    logger(logging.DEBUG, "Auto approving rule %s; Algorithm used for approval: %s", str(new_rule.id), configured_algorithm or 'default')
+                    logger(logging.DEBUG, "Created rule %s for injection", str(new_rule.id))
+                    approve_rule(rule_id=new_rule.id, notify_approvers=False, session=session)
+                    continue
+                else:
+                    logger(logging.DEBUG, "Created rule %s in waiting for approval", str(new_rule.id))
+                    __create_rule_approval_email(rule=new_rule, session=session)
+                    continue

             # Force ASYNC mode for large rules
             if did.length is not None and (did.length * copies) >= 10000:
--
2.39.2
